<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random forests using distribution-based loss functions with distRforest • distRforest</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Random forests using distribution-based loss functions with distRforest">
<meta property="og:description" content="distRforest">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">distRforest</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/distRforest.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/henckr/distRforest/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Random forests using distribution-based loss functions with distRforest</h1>
                        <h4 class="author">Roel Henckaerts</h4>
            
      
      <small class="dont-index">Source: <a href="http://github.com/henckr/distRforest/blob/master/vignettes/distRforest.Rmd"><code>vignettes/distRforest.Rmd</code></a></small>
      <div class="hidden name"><code>distRforest.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>
<style>
body {
text-align: justify}
</style>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">distRforest</span>)</pre></body></html></div>
<div id="automobile-insurance-claim-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#automobile-insurance-claim-dataset" class="anchor"></a>Automobile insurance claim dataset</h2>
<p>The use of <code>distRforest</code> will be illustrated with the <code>ausprivauto0405</code> dataset from the package <code>CASdatasets</code>:</p>
<blockquote>
<p>Third party insurance is a compulsory insurance for vehicle owners in Australia. It insures vehicle owners against injury caused to other drivers, passengers or pedestrians, as a result of an accident. The <code>ausprivauto0405</code> dataset is based on one-year vehicle insurance policies taken out in 2004 or 2005. There are 67856 policies, of which 4624 had at least one claim.</p>
</blockquote>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">CASdatasets</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">ausprivauto0405</span>)</pre></body></html></div>
<p>The <code>ausprivauto0405</code> dataset is a data.frame with 67856 observations and 9 variables (Exposure, VehValue, VehAge, VehBody, Gender, DrivAge, ClaimOcc, ClaimNb, ClaimAmount):</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">ausprivauto0405</span>)
<span class="co">#&gt; 'data.frame':    67856 obs. of  9 variables:</span>
<span class="co">#&gt;  $ Exposure   : num  0.304 0.649 0.569 0.318 0.649 ...</span>
<span class="co">#&gt;  $ VehValue   : num  1.06 1.03 3.26 4.14 0.72 2.01 1.6 1.47 0.52 0.38 ...</span>
<span class="co">#&gt;  $ VehAge     : Factor w/ 4 levels "old cars","oldest cars",..: 1 3 3 3 2 1 1 3 2 2 ...</span>
<span class="co">#&gt;  $ VehBody    : Factor w/ 13 levels "Bus","Convertible",..: 5 5 13 11 5 4 8 5 5 5 ...</span>
<span class="co">#&gt;  $ Gender     : Factor w/ 2 levels "Female","Male": 1 1 1 1 1 2 2 2 1 1 ...</span>
<span class="co">#&gt;  $ DrivAge    : Factor w/ 6 levels "old people","older work. people",..: 5 2 5 5 5 2 2 3 4 2 ...</span>
<span class="co">#&gt;  $ ClaimOcc   : int  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ ClaimNb    : int  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ ClaimAmount: num  0 0 0 0 0 0 0 0 0 0 ...</span></pre></body></html></div>
<p>Variables of interest are introduced when needed. For a full description see <code><a href="https://rdrr.io/pkg/CASdatasets/man/ausprivauto.html">?CASdatasets::ausprivauto0405</a></code>.</p>
</div>
<div id="building-a-random-forest-and-making-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#building-a-random-forest-and-making-predictions" class="anchor"></a>Building a random forest and making predictions</h2>
<p>This section introduces the functions to build a random forest and make predictions from it. Afterwards, examples of binary classification, Poisson regression and Gamma regression illustrate how to use them.</p>
<div id="build-a-random-forest" class="section level3">
<h3 class="hasAnchor">
<a href="#build-a-random-forest" class="anchor"></a>Build a random forest</h3>
<p>To build a random forest with the <code>distRforest</code> package, call the function <code>rforest(formula, data, method,</code> <code>weights = NULL, parms = NULL, control = NULL, ncand, ntrees, subsample = 1, track_oob = FALSE,</code> <code>keep_data = FALSE, red_mem = FALSE)</code> with the following arguments:</p>
<ul>
<li>
<code>formula</code>: object of the class <code>formula</code> with a symbolic description for the model to be fitted of the form <code>response ~ var1 + var2 + var3</code> without interactions. Please refrain from applying transformation functions to the response, but add the transformed variable to the <code>data</code> beforehand. Two exceptions exist, see <code>method = 'poisson'</code> and <code>method = 'exp'</code> below.</li>
<li>
<code>data</code>: data frame containing the training data observations.</li>
<li>
<code>method</code>: string specifying the type of forest to build. Options are:
<ul>
<li>
<code>'class'</code>: classification forest.</li>
<li>
<code>'anova'</code>: standard regression forest with a squared error loss.</li>
<li>
<code>'poisson'</code>: poisson regression forest for count data. The left-hand-side of <code>formula</code> can be specified as <code><a href="https://rdrr.io/r/base/cbind.html">cbind(observation_time, number_of_events)</a></code> to include time exposures.</li>
<li>
<code>'gamma'</code>: gamma regression forest for strictly positive long-tailed data.</li>
<li>
<code>'lognormal'</code>: lognormal regression forest for strictly positive long-tailed data.</li>
<li>
<code>'exp'</code>: exponential scaling for survival data. The left-hand-side of <code>formula</code> is specified as <code>Surv(observation_time, event_indicator)</code> to include time exposures.</li>
</ul>
</li>
<li>
<code>weights</code>: optional name of the variable in <code>data</code> to use as case weights. Either as a string or simply the variable name should work.</li>
<li>
<code>parms</code>: optional parameters for the splitting function, see <code><a href="../reference/rpart.html">?distRforest::rpart</a></code> for the details and allowed options.</li>
<li>
<code>control</code>: list of options that control the fitting details of the individual <code>rpart</code> trees. Use <code><a href="../reference/rpart.control.html">distRforest::rpart.control</a></code> to set this up.</li>
<li>
<code>ncand</code>: integer specifying the number of randomly chosen variable candidates to consider at each node to find the optimal split.</li>
<li>
<code>ntrees</code>: integer specifying the number of trees in the ensemble.</li>
<li>
<code>subsample</code>: numeric in the range [0,1]. Each tree in the ensemble is built on randomly sampled data of size <code>subsample * nrow(data)</code>.</li>
<li>
<code>track_oob</code>: boolean to indicate whether the out-of-bag errors should be tracked (<code>TRUE</code>) or not (<code>FALSE</code>). This option is not implemented for <code>method = 'exp'</code> or multi-class classification. For the other methods, the following errors are tracked. All the errors are evaluated in a weighted version if <code>weights</code> are supplied.
<ul>
<li>
<code>class</code>: Matthews correlation coefficient for binary classification.</li>
<li>
<code>anova</code>: mean squared error.</li>
<li>
<code>poisson</code>: Poisson deviance.</li>
<li>
<code>gamma</code>: gamma deviance.</li>
<li>
<code>lognormal</code>: mean squared error.</li>
</ul>
</li>
<li>
<code>keep_data</code>: boolean to indicate whether the <code>data</code> should be saved with the fit. It is not advised to set this to <code>TRUE</code> for large data sets.</li>
<li>
<code>red_mem</code>: boolean whether to reduce the memory footprint of the <code>rpart</code> trees by eliminating non-essential elements from the fits. It is adviced to set this to <code>TRUE</code> for large values of <code>ntrees</code>.</li>
</ul>
<p>The function returns an object of class <code>rforest</code> which is a list containing the following elements:</p>
<ul>
<li>
<code>trees</code>: list of length equal to <code>ntrees</code>, containing the individual <code>rpart</code> trees in the forest.</li>
<li>
<code>oob_error</code>: numeric vector of length equal to <code>ntrees</code>, containing the OOB error at each iteration (if <code>track_oob = TRUE</code>).</li>
<li>
<code>data</code>: the training <code>data</code> (if <code>keep_data = TRUE</code>).</li>
</ul>
</div>
<div id="make-predictions" class="section level3">
<h3 class="hasAnchor">
<a href="#make-predictions" class="anchor"></a>Make predictions</h3>
<p>Predictions from a random forest can be retrieved via the generic <code>predict</code> function, which will call <code><a href="../reference/predict.rforest.html">predict.rforest(object, newdata)</a></code> with arguments:</p>
<ul>
<li>
<code>object</code>: fitted model object from the class <code>rforest</code>.</li>
<li>
<code>newdata</code>: data frame containing the observations to predict. This argument can only be missing when the random forest in <code>object</code> is trained with <code>keep_data = TRUE</code>. In that case, the original training data will be used to generate predictions.</li>
</ul>
<p>The function returns a numeric vector containing a prediction for each observation. A majority vote among individual trees is taken for a binary classification forest, while the predictions of the individual trees are averaged for normal, poisson, gamma and lognormal regression forests.</p>
</div>
<div id="classification-forest-to-modelpredict-the-occurrence-of-a-claim" class="section level3">
<h3 class="hasAnchor">
<a href="#classification-forest-to-modelpredict-the-occurrence-of-a-claim" class="anchor"></a>Classification forest to model/predict the occurrence of a claim</h3>
<p>Assume that you want to model which type of policyholder in the portfolio is more likely to file a claim. The variable <code>ClaimOcc</code> in the <code>ausprivauto0405</code> data has the value <code>1</code> for policyholders who filed a claim and <code>0</code> otherwise. An insurance claim is an unlikely event, as most policyholders do not file a claim:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">ausprivauto0405</span>$<span class="no">ClaimOcc</span> <span class="kw">%&gt;%</span> <span class="no">table</span> <span class="kw">%&gt;%</span> <span class="no">prop.table</span>
<span class="co">#&gt; .</span>
<span class="co">#&gt;          0          1 </span>
<span class="co">#&gt; 0.93185569 0.06814431</span></pre></body></html></div>
<p><strong>It is important that your binary classification response is a numeric or factor with the value 0/1 for the negative/positive class to make sure that everything runs smoothly!</strong></p>
<p>Let’s build a binary classification forest for claim occurrence on a (naively) balanced dataset:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># Balance the data</span>
<span class="no">ausprivauto0405_balanced</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">ausprivauto0405</span>[<span class="no">ausprivauto0405</span>$<span class="no">ClaimOcc</span> <span class="kw">==</span> <span class="fl">1</span>, ],
                                  <span class="no">ausprivauto0405</span>[<span class="no">ausprivauto0405</span>$<span class="no">ClaimOcc</span> <span class="kw">==</span> <span class="fl">0</span>, ][<span class="fl">1</span>:<span class="fl">5000</span>, ])
<span class="co"># Build the random forest</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">54321</span>)
<span class="no">rf_class</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rforest.html">rforest</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">ClaimOcc</span> ~ <span class="no">VehValue</span> + <span class="no">VehAge</span> + <span class="no">VehBody</span> + <span class="no">Gender</span> + <span class="no">DrivAge</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">ausprivauto0405_balanced</span>,
                    <span class="kw">method</span> <span class="kw">=</span> <span class="st">'class'</span>,
                    <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="../reference/rpart.control.html">rpart.control</a></span>(<span class="kw">minsplit</span> <span class="kw">=</span> <span class="fl">20</span>, <span class="kw">cp</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">xval</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">maxdepth</span> <span class="kw">=</span> <span class="fl">5</span>),
                    <span class="kw">ncand</span> <span class="kw">=</span> <span class="fl">3</span>,
                    <span class="kw">ntrees</span> <span class="kw">=</span> <span class="fl">200</span>,
                    <span class="kw">subsample</span> <span class="kw">=</span> <span class="fl">0.5</span>,
                    <span class="kw">track_oob</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">keep_data</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">red_mem</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>The fit is of the class <code>rforest</code>, which is a <code>list</code> containing the individual <code>trees</code>, the <code>oob_error</code> and the <code>data</code>.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">rf_class</span>)
<span class="co">#&gt; [1] "rforest" "list"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">rf_class</span>)
<span class="co">#&gt; [1] "trees"     "oob_error" "data"</span>
<span class="no">rf_class</span><span class="kw">[[</span><span class="st">'trees'</span>]]<span class="kw">[[</span><span class="fl">1</span>]]
<span class="co">#&gt; n= 4812 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; node), split, n, loss, yval, (yprob)</span>
<span class="co">#&gt;       * denotes terminal node</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1) root 4812 2334 1  </span>
<span class="co">#&gt;    2) VehValue&lt; 1.255 1600  695 1  </span>
<span class="co">#&gt;      4) VehValue&gt;=1.195 125   36 1 *</span>
<span class="co">#&gt;      5) VehValue&lt; 1.195 1475  659 1  </span>
<span class="co">#&gt;       10) DrivAge=old people,oldest people 399  151 1  </span>
<span class="co">#&gt;         20) VehValue&lt; 1.135 365  133 1 *</span>
<span class="co">#&gt;         21) VehValue&gt;=1.135 34   16 2  </span>
<span class="co">#&gt;           42) DrivAge=oldest people 17    6 1 *</span>
<span class="co">#&gt;           43) DrivAge=old people 17    5 2 *</span>
<span class="co">#&gt;       11) DrivAge=older work. people,working people,young people,youngest people 1076  508 1 *</span>
<span class="co">#&gt;    3) VehValue&gt;=1.255 3212 1573 2  </span>
<span class="co">#&gt;      6) DrivAge=old people,older work. people,oldest people,working people,young people 2902 1439 1  </span>
<span class="co">#&gt;       12) VehBody=Convertible,Coupe,Hardtop,Truck 187   72 1  </span>
<span class="co">#&gt;         24) VehAge=oldest cars 49   13 1 *</span>
<span class="co">#&gt;         25) VehAge=old cars,young cars,youngest cars 138   59 1  </span>
<span class="co">#&gt;           50) DrivAge=old people,older work. people,oldest people,young people 109   40 1 *</span>
<span class="co">#&gt;           51) DrivAge=working people 29   10 2 *</span>
<span class="co">#&gt;       13) VehBody=Bus,Hatchback,Minibus,Motorized caravan,Panel van,Roadster,Sedan,Station wagon,Utility 2715 1348 2  </span>
<span class="co">#&gt;         26) VehValue&gt;=1.365 2447 1210 1  </span>
<span class="co">#&gt;           52) VehValue&lt; 2.0945 1293  602 1 *</span>
<span class="co">#&gt;           53) VehValue&gt;=2.0945 1154  546 2 *</span>
<span class="co">#&gt;         27) VehValue&lt; 1.365 268  111 2 *</span>
<span class="co">#&gt;      7) DrivAge=youngest people 310  110 2  </span>
<span class="co">#&gt;       14) VehValue&gt;=3.415 32   12 1 *</span>
<span class="co">#&gt;       15) VehValue&lt; 3.415 278   90 2 *</span></pre></body></html></div>
<p>The OOB error evolution (<code>track_oob = TRUE</code> in <code>rforest</code>) shows an increasing trend in Matthews correlation coefficient, which means that the classification is improving over the iterations:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">oob_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'iteration'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">rf_class</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])),
                     <span class="st">'oob_error'</span> <span class="kw">=</span> <span class="no">rf_class</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])
<span class="fu">ggplot</span>(<span class="no">oob_df</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">oob_error</span>)) + <span class="fu">geom_point</span>()</pre></body></html></div>
<p><img src="distRforest_files/figure-html/class_oob-1.png" width="672"></p>
<p><em>Sidenote: Matthews correlation coefficient is chosen because this measure takes into account all four elements of the confusion matrix. Measures like accuracy, precision, recall or the F1 score ignore at least one of them.</em></p>
<p>Predictions from the random forest can be compared to the true values to assess performance. A reasonable amount of observations are classified falsely, but this is likely driven by the limited number of iterations and variables involved to model claim occurrence. Note that there is no need to specify <code>newdata</code> in <code>predict</code> as <code>keep_data = TRUE</code> in <code>rforest</code>. If <code>keep_data = FALSE</code> then <code>newdata = ausprivauto0405_balanced</code> is needed.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">pred_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'true'</span> <span class="kw">=</span> <span class="no">ausprivauto0405_balanced</span>$<span class="no">ClaimOcc</span>,
                      <span class="st">'pred'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">rf_class</span>))
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">'True positives: %i'</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">pred_df</span>$<span class="no">true</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">&amp;</span> <span class="no">pred_df</span>$<span class="no">pred</span> <span class="kw">==</span> <span class="fl">1</span>))
<span class="co">#&gt; [1] "True positives: 2054"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">'False positives: %i'</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">pred_df</span>$<span class="no">true</span> <span class="kw">==</span> <span class="fl">0</span> <span class="kw">&amp;</span> <span class="no">pred_df</span>$<span class="no">pred</span> <span class="kw">==</span> <span class="fl">1</span>))
<span class="co">#&gt; [1] "False positives: 1644"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">'True negatives: %i'</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">pred_df</span>$<span class="no">true</span> <span class="kw">==</span> <span class="fl">0</span> <span class="kw">&amp;</span> <span class="no">pred_df</span>$<span class="no">pred</span> <span class="kw">==</span> <span class="fl">0</span>))
<span class="co">#&gt; [1] "True negatives: 3356"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">'False negatives: %i'</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">pred_df</span>$<span class="no">true</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">&amp;</span> <span class="no">pred_df</span>$<span class="no">pred</span> <span class="kw">==</span> <span class="fl">0</span>))
<span class="co">#&gt; [1] "False negatives: 2570"</span></pre></body></html></div>
</div>
<div id="poisson-regression-forest-to-modelpredict-claim-numbers" class="section level3">
<h3 class="hasAnchor">
<a href="#poisson-regression-forest-to-modelpredict-claim-numbers" class="anchor"></a>Poisson regression forest to model/predict claim numbers</h3>
<p>Although most policyholders do not file a claim in the portfolio, some of them file more than one claim. The variable <code>ClaimNb</code> in the <code>ausprivauto0405</code> data contains the number of claims filed by a specific policyholder. The variable <code>Exposure</code> contains the fraction of the year that a policyholder was covered by the policy and therefore exposed to the risk of filing a claim. This information should be taken into account as filing a claim during one year or one month of exposure represents a different risk.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">ausprivauto0405</span>$<span class="no">ClaimNb</span> <span class="kw">%&gt;%</span> <span class="no">table</span> <span class="kw">%&gt;%</span> <span class="no">prop.table</span>
<span class="co">#&gt; .</span>
<span class="co">#&gt;            0            1            2            3            4 </span>
<span class="co">#&gt; 9.318557e-01 6.385581e-02 3.993751e-03 2.652676e-04 2.947418e-05</span>
<span class="no">ausprivauto0405</span>$<span class="no">Exposure</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span>))
<span class="co">#&gt;          0%         20%         40%         60%         80%        100% </span>
<span class="co">#&gt; 0.002737851 0.175222450 0.347707050 0.550308008 0.772073922 0.999315537</span></pre></body></html></div>
<p>Let’s build a Poisson regression forest which takes the exposure into account via <code>cbind</code> in the <code>formula</code>:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># Build the random forest</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">54321</span>)
<span class="no">rf_poiss</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rforest.html">rforest</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">Exposure</span>, <span class="no">ClaimNb</span>) ~ <span class="no">VehValue</span> + <span class="no">VehAge</span> + <span class="no">VehBody</span> + <span class="no">Gender</span> + <span class="no">DrivAge</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">ausprivauto0405</span>,
                    <span class="kw">method</span> <span class="kw">=</span> <span class="st">'poisson'</span>,
                    <span class="kw">parms</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">'shrink'</span> <span class="kw">=</span> <span class="fl">10000000</span>),
                    <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="../reference/rpart.control.html">rpart.control</a></span>(<span class="kw">minsplit</span> <span class="kw">=</span> <span class="fl">20</span>, <span class="kw">cp</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">xval</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">maxdepth</span> <span class="kw">=</span> <span class="fl">5</span>),
                    <span class="kw">ncand</span> <span class="kw">=</span> <span class="fl">3</span>,
                    <span class="kw">ntrees</span> <span class="kw">=</span> <span class="fl">200</span>,
                    <span class="kw">subsample</span> <span class="kw">=</span> <span class="fl">0.5</span>,
                    <span class="kw">track_oob</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">keep_data</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">red_mem</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>The fit is of the class <code>rforest</code>, which is a <code>list</code> containing the individual <code>trees</code>, the <code>oob_error</code> and the <code>data</code>.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">rf_poiss</span>)
<span class="co">#&gt; [1] "rforest" "list"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">rf_poiss</span>)
<span class="co">#&gt; [1] "trees"     "oob_error" "data"</span>
<span class="no">rf_poiss</span><span class="kw">[[</span><span class="st">'trees'</span>]]<span class="kw">[[</span><span class="fl">1</span>]]
<span class="co">#&gt; n= 33928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; node), split, n, deviance, yval</span>
<span class="co">#&gt;       * denotes terminal node</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1) root 33928 1.279984e+04 1.560523e-01  </span>
<span class="co">#&gt;    2) VehValue&lt; 1.315 13430 4.734168e+03 1.332482e-01  </span>
<span class="co">#&gt;      4) VehBody=Convertible,Minibus,Motorized caravan,Utility 832 1.340727e+02 5.185884e-02  </span>
<span class="co">#&gt;        8) DrivAge=older work. people 182 2.000000e-14 1.318592e-16 *</span>
<span class="co">#&gt;        9) DrivAge=old people,oldest people,working people,young people,youngest people 650 1.252595e+02 6.539531e-02  </span>
<span class="co">#&gt;         18) VehBody=Convertible,Minibus,Motorized caravan 93 2.000000e-14 2.562439e-16 *</span>
<span class="co">#&gt;         19) VehBody=Utility 557 1.197784e+02 7.554209e-02  </span>
<span class="co">#&gt;           38) DrivAge=working people,young people 329 5.520418e+01 4.904660e-02 *</span>
<span class="co">#&gt;           39) DrivAge=old people,oldest people,youngest people 228 6.153674e+01 1.103002e-01 *</span>
<span class="co">#&gt;      5) VehBody=Bus,Coupe,Hardtop,Hatchback,Panel van,Sedan,Station wagon,Truck 12598 4.575197e+03 1.383151e-01  </span>
<span class="co">#&gt;       10) DrivAge=old people,oldest people 3467 1.086653e+03 1.081414e-01  </span>
<span class="co">#&gt;         20) VehBody=Coupe,Hardtop,Hatchback,Panel van,Sedan,Station wagon 3375 1.036962e+03 1.035525e-01  </span>
<span class="co">#&gt;           40) VehAge=old cars,oldest cars 3067 8.980670e+02 9.590917e-02 *</span>
<span class="co">#&gt;           41) VehAge=young cars,youngest cars 308 1.314579e+02 1.773696e-01 *</span>
<span class="co">#&gt;         21) VehBody=Bus,Truck 92 4.101172e+01 2.848879e-01  </span>
<span class="co">#&gt;           42) VehValue&lt; 0.96 54 1.239096e+01 8.673712e-02 *</span>
<span class="co">#&gt;           43) VehValue&gt;=0.96 38 2.116840e+01 5.245584e-01 *</span>
<span class="co">#&gt;       11) DrivAge=older work. people,working people,young people,youngest people 9131 3.472489e+03 1.502146e-01  </span>
<span class="co">#&gt;         22) VehBody=Hardtop,Panel van,Station wagon,Truck 1573 5.313250e+02 1.231814e-01  </span>
<span class="co">#&gt;           44) DrivAge=older work. people,working people,youngest people 1185 3.857044e+02 1.148979e-01 *</span>
<span class="co">#&gt;           45) DrivAge=young people 388 1.442614e+02 1.512880e-01 *</span>
<span class="co">#&gt;         23) VehBody=Bus,Coupe,Hatchback,Sedan 7558 2.936459e+03 1.561038e-01  </span>
<span class="co">#&gt;           46) VehValue&lt; 0.995 4808 1.760499e+03 1.420909e-01 *</span>
<span class="co">#&gt;           47) VehValue&gt;=0.995 2750 1.168747e+03 1.797086e-01 *</span>
<span class="co">#&gt;    3) VehValue&gt;=1.315 20498 8.030652e+03 1.708299e-01  </span>
<span class="co">#&gt;      6) VehBody=Bus,Convertible,Roadster 66 2.000000e-14 3.301247e-16 *</span>
<span class="co">#&gt;      7) VehBody=Coupe,Hardtop,Hatchback,Minibus,Motorized caravan,Panel van,Sedan,Station wagon,Truck,Utility 20432 8.020286e+03 1.713680e-01  </span>
<span class="co">#&gt;       14) DrivAge=old people,older work. people,oldest people,working people 14820 5.505612e+03 1.562594e-01  </span>
<span class="co">#&gt;         28) DrivAge=old people,oldest people 5010 1.717314e+03 1.364118e-01  </span>
<span class="co">#&gt;           56) VehValue&lt; 2.935 4072 1.306061e+03 1.228986e-01 *</span>
<span class="co">#&gt;           57) VehValue&gt;=2.935 938 3.983710e+02 1.955371e-01 *</span>
<span class="co">#&gt;         29) DrivAge=older work. people,working people 9810 3.778820e+03 1.665797e-01  </span>
<span class="co">#&gt;           58) VehBody=Hatchback,Minibus,Panel van,Sedan,Station wagon,Truck,Utility 9381 3.544578e+03 1.610321e-01 *</span>
<span class="co">#&gt;           59) VehBody=Coupe,Hardtop,Motorized caravan 429 2.188568e+02 2.862575e-01 *</span>
<span class="co">#&gt;       15) DrivAge=young people,youngest people 5612 2.480701e+03 2.133463e-01  </span>
<span class="co">#&gt;         30) VehValue&gt;=5.8 48 2.000000e-14 4.563343e-16 *</span>
<span class="co">#&gt;         31) VehValue&lt; 5.8 5564 2.471310e+03 2.151991e-01  </span>
<span class="co">#&gt;           62) VehValue&lt; 2.825 4202 1.820430e+03 2.009332e-01 *</span>
<span class="co">#&gt;           63) VehValue&gt;=2.825 1362 6.437423e+02 2.597354e-01 *</span></pre></body></html></div>
<p>The OOB error evolution (<code>track_oob = TRUE</code> in <code>rforest</code>) shows a decreasing trend in the Poisson deviance, which means that the predictions for the claim numbers are improving over the iterations:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">oob_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'iteration'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">rf_poiss</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])),
                     <span class="st">'oob_error'</span> <span class="kw">=</span> <span class="no">rf_poiss</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])
<span class="fu">ggplot</span>(<span class="no">oob_df</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">oob_error</span>)) + <span class="fu">geom_point</span>()</pre></body></html></div>
<p><img src="distRforest_files/figure-html/poiss_oob-1.png" width="672"></p>
<p>Predictions from the random forest can be compared to the true values to assess performance. Note that predictions from a Poisson forest are given on a scale of full time exposure (i.e., setting <code>Exposure = 1</code> in our case), so you need to multiply predictions with observed <code>Exposure</code> values. Policyholders are split in 5 groups based on their predicted values, going from low to high risk, and the mean of the observed number of claims is calculated per group. The increasing trend shows that the Poisson forest is able to model the risk properly:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">pred_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'true'</span> <span class="kw">=</span> <span class="no">ausprivauto0405</span>$<span class="no">ClaimNb</span>,
                      <span class="st">'pred'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">rf_poiss</span>) * <span class="no">ausprivauto0405</span>$<span class="no">Exposure</span>)
<span class="no">split_df</span> <span class="kw">&lt;-</span> <span class="no">pred_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">pred_df</span>$<span class="no">pred</span>,
                                  <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred_df</span>$<span class="no">pred</span>, <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span>)),
                                  <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'lowest risk'</span>, <span class="st">'low risk'</span>, <span class="st">'medium risk'</span>, <span class="st">'high risk'</span>, <span class="st">'highest risk'</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">split_df</span>, <span class="kw">function</span>(<span class="no">df_sub</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">df_sub</span>$<span class="no">true</span>))
<span class="co">#&gt; $`lowest risk`</span>
<span class="co">#&gt; [1] 0.02203227</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`low risk`</span>
<span class="co">#&gt; [1] 0.04111709</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`medium risk`</span>
<span class="co">#&gt; [1] 0.06845479</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`high risk`</span>
<span class="co">#&gt; [1] 0.0946872</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`highest risk`</span>
<span class="co">#&gt; [1] 0.1374991</span></pre></body></html></div>
</div>
<div id="gamma-regression-forest-to-modelpredict-the-claim-amounts" class="section level3">
<h3 class="hasAnchor">
<a href="#gamma-regression-forest-to-modelpredict-the-claim-amounts" class="anchor"></a>Gamma regression forest to model/predict the claim amounts</h3>
<p>Besides estimating how frequent a policyholder will file a claim, it is also important to get an idea of the actual severity of the claims in money terms. The variable <code>ClaimAmount</code> in the <code>ausprivauto0405</code> data contains the sum of claim payments over all claims filed by a specific policyholder. To approximate the individual claim amounts, a new variable <code>ClaimAvg</code> is defined for the average claim payment, but only for those policyholders actually filing a claim. These claim amounts are clearly long-tailed, which calls for appropriate statistical assumptions:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">ausprivauto0405_claims</span> <span class="kw">&lt;-</span> <span class="no">ausprivauto0405</span>[<span class="no">ausprivauto0405</span>$<span class="no">ClaimOcc</span> <span class="kw">==</span> <span class="fl">1</span>, ]
<span class="no">ausprivauto0405_claims</span>$<span class="no">ClaimAvg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">ausprivauto0405_claims</span>, <span class="no">ClaimAmount</span> / <span class="no">ClaimNb</span>)
<span class="no">ausprivauto0405_claims</span>$<span class="no">ClaimAvg</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span>))
<span class="co">#&gt;        0%       20%       40%       60%       80%      100% </span>
<span class="co">#&gt;   200.000   331.196   474.120  1047.107  2531.574 55922.130</span></pre></body></html></div>
<p>Let’s build a gamma regression forest for the average claim amount and the number of claims as case weights:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># Build the random forest</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">54321</span>)
<span class="no">rf_gamma</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rforest.html">rforest</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">ClaimAvg</span> ~ <span class="no">VehValue</span> + <span class="no">VehAge</span> + <span class="no">VehBody</span> + <span class="no">Gender</span> + <span class="no">DrivAge</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">ausprivauto0405_claims</span>,
                    <span class="kw">weights</span> <span class="kw">=</span> <span class="no">ClaimNb</span>,
                    <span class="kw">method</span> <span class="kw">=</span> <span class="st">'gamma'</span>,
                    <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="../reference/rpart.control.html">rpart.control</a></span>(<span class="kw">minsplit</span> <span class="kw">=</span> <span class="fl">20</span>, <span class="kw">cp</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">xval</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">maxdepth</span> <span class="kw">=</span> <span class="fl">5</span>),
                    <span class="kw">ncand</span> <span class="kw">=</span> <span class="fl">3</span>,
                    <span class="kw">ntrees</span> <span class="kw">=</span> <span class="fl">200</span>,
                    <span class="kw">subsample</span> <span class="kw">=</span> <span class="fl">0.5</span>,
                    <span class="kw">track_oob</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">keep_data</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                    <span class="kw">red_mem</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>The fit is of the class <code>rforest</code>, which is a <code>list</code> containing the individual <code>trees</code>, the <code>oob_error</code> and the <code>data</code>.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">rf_gamma</span>)
<span class="co">#&gt; [1] "rforest" "list"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">rf_gamma</span>)
<span class="co">#&gt; [1] "trees"     "oob_error" "data"</span>
<span class="no">rf_gamma</span><span class="kw">[[</span><span class="st">'trees'</span>]]<span class="kw">[[</span><span class="fl">1</span>]]
<span class="co">#&gt; n= 2312 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; node), split, n, deviance, yval</span>
<span class="co">#&gt;       * denotes terminal node</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1) root 2312 3984.090000  1914.7440  </span>
<span class="co">#&gt;    2) VehValue&lt; 4.775 2267 3787.457000  1861.5260  </span>
<span class="co">#&gt;      4) VehBody=Bus,Convertible,Motorized caravan,Roadster,Sedan,Station wagon 1342 2025.679000  1654.4600  </span>
<span class="co">#&gt;        8) Gender=Female 748 1047.747000  1438.5220  </span>
<span class="co">#&gt;         16) VehValue&gt;=1.145 573  728.398000  1264.5970  </span>
<span class="co">#&gt;           32) VehAge=youngest cars 121  105.963200   819.6848 *</span>
<span class="co">#&gt;           33) VehAge=old cars,oldest cars,young cars 452  596.883000  1385.0180 *</span>
<span class="co">#&gt;         17) VehValue&lt; 1.145 175  286.254100  2004.4670  </span>
<span class="co">#&gt;           34) DrivAge=old people,oldest people,working people,youngest people 87  123.167500  1622.2780 *</span>
<span class="co">#&gt;           35) DrivAge=older work. people,young people 88  156.535300  2359.3570 *</span>
<span class="co">#&gt;        9) Gender=Male 594  947.536300  1922.7970  </span>
<span class="co">#&gt;         18) VehBody=Bus,Motorized caravan 15    6.425651   695.5565 *</span>
<span class="co">#&gt;         19) VehBody=Sedan,Station wagon 579  928.054600  1955.9130  </span>
<span class="co">#&gt;           38) VehValue&gt;=2.185 192  220.938300  1429.2740 *</span>
<span class="co">#&gt;           39) VehValue&lt; 2.185 387  682.129500  2211.7800 *</span>
<span class="co">#&gt;      5) VehBody=Coupe,Hardtop,Hatchback,Minibus,Panel van,Truck,Utility 925 1718.411000  2167.7990  </span>
<span class="co">#&gt;       10) DrivAge=old people,older work. people,working people,young people 700 1229.436000  2002.5170  </span>
<span class="co">#&gt;         20) VehAge=young cars 184  287.987100  1703.9210  </span>
<span class="co">#&gt;           40) VehValue&gt;=2.84 21    7.486495   524.7348 *</span>
<span class="co">#&gt;           41) VehValue&lt; 2.84 163  258.929700  1848.7330 *</span>
<span class="co">#&gt;         21) VehAge=old cars,oldest cars,youngest cars 516  935.240300  2108.2920  </span>
<span class="co">#&gt;           42) VehBody=Coupe,Hardtop,Hatchback,Utility 439  786.531600  1997.9910 *</span>
<span class="co">#&gt;           43) VehBody=Minibus,Panel van,Truck 77  141.297400  2745.2810 *</span>
<span class="co">#&gt;       11) DrivAge=oldest people,youngest people 225  473.438200  2658.9620  </span>
<span class="co">#&gt;         22) VehBody=Coupe,Hatchback,Panel van,Utility 203  396.436500  2367.6670  </span>
<span class="co">#&gt;           44) VehValue&lt; 1.605 140  223.484200  1756.7350 *</span>
<span class="co">#&gt;           45) VehValue&gt;=1.605 63  145.627500  3631.9570 *</span>
<span class="co">#&gt;         23) VehBody=Hardtop,Truck 22   59.939320  5134.9700  </span>
<span class="co">#&gt;           46) VehAge=oldest cars,youngest cars 7    5.312453  1203.6770 *</span>
<span class="co">#&gt;           47) VehAge=old cars,young cars 15   43.758960  6583.3410 *</span>
<span class="co">#&gt;    3) VehValue&gt;=4.775 45  144.483700  4556.0940  </span>
<span class="co">#&gt;      6) VehAge=oldest cars,youngest cars 31   54.020370  1346.9800  </span>
<span class="co">#&gt;       12) DrivAge=older work. people,oldest people,working people,young people 23   12.690010   706.2741  </span>
<span class="co">#&gt;         24) Gender=Female 9    4.113463   544.1127 *</span>
<span class="co">#&gt;         25) Gender=Male 14    7.528009   817.7600 *</span>
<span class="co">#&gt;       13) DrivAge=old people,youngest people 8   21.788170  3509.3610 *</span>
<span class="co">#&gt;      7) VehAge=old cars,young cars 14   33.596730 12578.8800 *</span></pre></body></html></div>
<p>The OOB error evolution (<code>track_oob = TRUE</code> in <code>rforest</code>) shows a decreasing trend in the gamma deviance, which means that the predictions for the claim amounts are improving over the iterations:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">oob_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'iteration'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">rf_gamma</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])),
                     <span class="st">'oob_error'</span> <span class="kw">=</span> <span class="no">rf_gamma</span><span class="kw">[[</span><span class="st">'oob_error'</span>]])
<span class="fu">ggplot</span>(<span class="no">oob_df</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">oob_error</span>)) + <span class="fu">geom_point</span>()</pre></body></html></div>
<p><img src="distRforest_files/figure-html/gamma_oob-1.png" width="672"></p>
<p>Predictions from the random forest can be compared to the true values to assess performance. Note that the predictions are being made for the average claim amount, so you need to multiply predictions with observed <code>ClaimNb</code> values to get the aggregate claim cost prediction. Policyholders are split in 5 groups based on their predicted values, going from low to high risk, and the mean of the observed claim amounts is calculated per group. The increasing trend shows that the gamma forest is able to model the risk properly:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">pred_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">'true'</span> <span class="kw">=</span> <span class="no">ausprivauto0405_claims</span>$<span class="no">ClaimAmount</span>,
                      <span class="st">'pred'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">rf_gamma</span>) * <span class="no">ausprivauto0405_claims</span>$<span class="no">ClaimNb</span>)
<span class="no">split_df</span> <span class="kw">&lt;-</span> <span class="no">pred_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">pred_df</span>$<span class="no">pred</span>,
                                  <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">pred_df</span>$<span class="no">pred</span>, <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span>)),
                                  <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'lowest risk'</span>, <span class="st">'low risk'</span>, <span class="st">'medium risk'</span>, <span class="st">'high risk'</span>, <span class="st">'highest risk'</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">split_df</span>, <span class="kw">function</span>(<span class="no">df_sub</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">df_sub</span>$<span class="no">true</span>))
<span class="co">#&gt; $`lowest risk`</span>
<span class="co">#&gt; [1] 1137.374</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`low risk`</span>
<span class="co">#&gt; [1] 1515.216</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`medium risk`</span>
<span class="co">#&gt; [1] 1783.012</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`high risk`</span>
<span class="co">#&gt; [1] 2248.87</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`highest risk`</span>
<span class="co">#&gt; [1] 3389.096</span></pre></body></html></div>
</div>
</div>
<div id="assessing-the-importance-of-each-variable" class="section level2">
<h2 class="hasAnchor">
<a href="#assessing-the-importance-of-each-variable" class="anchor"></a>Assessing the importance of each variable</h2>
<p>The <code>distRforest</code> package allows for an easy calculation of variable importance scores for an <code>rforest</code> object. The function <code>importance_rforest</code> takes one argument, namely the fitted <code>rforest</code> object. The result is a data frame with one row per variable and four columns:</p>
<ul>
<li>
<code>variable</code>: name of the variable.</li>
<li>
<code>importance</code>: average importance score, taken over all the individual trees.</li>
<li>
<code>scale_sum</code>: scaled scores which sum to one.</li>
<li>
<code>scale_max</code>: scaled scores such that the maximum value is equal to one.</li>
</ul>
<p>Assessing the importance of each variable in the three forests built before shows a rather uniform ranking:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">rf_class</span> <span class="kw">%&gt;%</span> <span class="no">importance_rforest</span>
<span class="co">#&gt;   variable importance  scale_sum  scale_max</span>
<span class="co">#&gt; 1 VehValue  33.780268 0.38838995 1.00000000</span>
<span class="co">#&gt; 2  DrivAge  22.801008 0.26215548 0.67498008</span>
<span class="co">#&gt; 3  VehBody  19.022700 0.21871424 0.56313052</span>
<span class="co">#&gt; 4   VehAge   9.741263 0.11200055 0.28837140</span>
<span class="co">#&gt; 5   Gender   1.629895 0.01873978 0.04824991</span>
<span class="no">rf_poiss</span> <span class="kw">%&gt;%</span> <span class="no">importance_rforest</span>
<span class="co">#&gt;   variable importance  scale_sum  scale_max</span>
<span class="co">#&gt; 1 VehValue 100.271035 0.37553292 1.00000000</span>
<span class="co">#&gt; 2  VehBody  67.334582 0.25218003 0.67152576</span>
<span class="co">#&gt; 3  DrivAge  62.665775 0.23469451 0.62496388</span>
<span class="co">#&gt; 4   VehAge  28.575436 0.10702011 0.28498196</span>
<span class="co">#&gt; 5   Gender   8.163141 0.03057242 0.08141076</span>
<span class="no">rf_gamma</span> <span class="kw">%&gt;%</span> <span class="no">importance_rforest</span>
<span class="co">#&gt;   variable importance  scale_sum scale_max</span>
<span class="co">#&gt; 1 VehValue  181.66455 0.39426950 1.0000000</span>
<span class="co">#&gt; 2  VehBody  107.60177 0.23352986 0.5923102</span>
<span class="co">#&gt; 3  DrivAge   88.50472 0.19208323 0.4871876</span>
<span class="co">#&gt; 4   VehAge   57.00526 0.12371943 0.3137941</span>
<span class="co">#&gt; 5   Gender   25.98607 0.05639798 0.1430442</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Roel Henckaerts.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
